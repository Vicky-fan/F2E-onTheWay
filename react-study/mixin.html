<!doctype html>
<html>
<head>
	<meta charset="utf-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>组件生命周期</title>
	<h2>组件生命周期</h2>
	<div id="app"></div>
	
	<script src="build/react.js"></script>
	<script src="build/JSXTransformer.js"></script>
	<script type="text/jsx">
	var stateRecordMixin = {
		componentWillMount:  function () {
			this.oldStates = [];
		},		
		componentWillUpdate: function (nextProps, nextState) {
			this.oldStates.push(nextState);
		},
		previousState: function () {
			var index = this.oldStates.length-1;
			return index == -1 ? {} : this.oldStates[index];
		}
	};
	var LifeApp = React.createClass({
		mixins: [stateRecordMixin],
		getInitialState: function () {
			return {
				count: 0
			}
		},
		getDefaultProps: function () {
			return {}
		},

		doUpdate: function () {
			this.setState({
				count: this.state.count + 1
			});
			alert('上一次计数是：' + this.previousState().count);
		},

		render: function () {
			console.log('渲染');
			return (
				<div>
					<p>当前技数是{this.state.count}</p>
					<button onClick={this.doUpdate}>手动更新一下组件（包括子组件）</button>
					<SubApp count={this.state.count} />
				</div>
			)
		}
	});

	var SubApp = React.createClass({
		mixins: [stateRecordMixin],
		getInitialState: function () {
			return {
				count: 0
			}
		},
		componentWillReceiveProps: function (nextProps) {
			this.setState({
				count: this.props.count * 2
			});
		},
		render: function () {
			console.log('上一次子组件的计数是：'+this.previousState().count )
			return (
				<p>子组件当前的计数是： {this.state.count}</p>
			)
		}
	});
	var lifeApp = React.render(
		<LifeApp />,
		document.getElementById('app'),
		function () {
			console.log('渲染完毕！');
		}
	);
	
	</script>
</head>
<body>
	